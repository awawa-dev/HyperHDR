name: HyperHDR CI Build

on:
  push:

env:
    USE_CACHE: "1"
    RESET_CACHE: "0"
    USE_CODEQL: "0"
    BUILD_ARCHIVES: ${{ startsWith(github.event.ref, 'refs/tags') && 1 || 0 }}

jobs:

######################
####### macOS ########
######################

  macOS:
    name: macOS
    runs-on: macos-12
    env:     
      QT_VERSION: "5"
    steps:
      # Checkout
      - uses: actions/checkout@v3
        with:
            submodules: true

      # Generate cache id
      - name: Prepare ccache timestamp
        if: env.USE_CACHE == '1'
        id: ccache_cache_timestamp
        shell: cmake -P {0}
        run: |
            string(TIMESTAMP current_date "%Y-%m-%d-%H-%M-%S" UTC)
            file(APPEND "$ENV{GITHUB_OUTPUT}" "timestamp=${current_date}")

      # Download cache
      - name: ccache cache files
        if: ( env.USE_CACHE == '1' )
        uses: actions/cache@v3
        with:
            path: .ccache
            key: macOS-ccache-${{ steps.ccache_cache_timestamp.outputs.timestamp }}
            restore-keys: macOS-ccache-

      # Install deps
      - name: Install deps
        shell: bash
        run: brew update && brew install qt@${{ env.QT_VERSION }} xz ccache zstd webp
        
      # Set env
      - name: Set QT5 env
        if: ( env.QT_VERSION == '5' )
        shell: bash
        run: |
            export Qt5_DIR=`brew --prefix qt5`;
            echo "Qt5_DIR=$Qt5_DIR" >> $GITHUB_ENV
            
        # Build process
      - name: Build packages
        env:
            PLATFORM: osx
            USE_CCACHE: ${{ env.USE_CACHE }}
            RESET_CACHE: ${{ env.RESET_CACHE }}
        shell: bash
        run: ./.ci/ci_build.sh

      # Upload artifacts (only on tagged commit)
      - name: Upload artifacts
        if: startsWith(github.event.ref, 'refs/tags') && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v3
        with:
            path: build/Hyper*.dmg

      # Upload artifacts from commit
      - name: Upload artifacts from commit
        if: (startsWith(github.event.ref, 'refs/tags') != true) && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v3
        with:
            name: Apple_macOS_x64_DMG_installer
            path: build/Hyper*.dmg

